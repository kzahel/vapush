<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>vapush</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 400px;
      margin: 40px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    h1 { margin: 0 0 20px; font-size: 24px; }
    button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 12px;
    }
    #subscribe {
      background: #4a9eff;
      color: white;
    }
    #subscribe:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    #unsubscribe {
      background: #333;
      color: #aaa;
    }
    #status {
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
    }
    .success { background: #1a3a1a; color: #4ade80; }
    .error { background: #3a1a1a; color: #f87171; }
    .info { background: #1a2a3a; color: #60a5fa; }
  </style>
</head>
<body>
  <h1>vapush</h1>
  <button id="subscribe">Enable Notifications</button>
  <button id="unsubscribe" style="display:none">Disable Notifications</button>
  <div id="status"></div>

  <script>
    const status = document.getElementById("status");
    const subscribeBtn = document.getElementById("subscribe");
    const unsubscribeBtn = document.getElementById("unsubscribe");

    // Get secret from URL fragment
    const params = new URLSearchParams(window.location.hash.slice(1));
    const secret = params.get("s");

    if (!secret) {
      status.textContent = "Missing secret in URL. Use /#s=YOUR_SECRET";
      status.className = "error";
      subscribeBtn.disabled = true;
    }

    // Generate a stable browser ID
    function getBrowserId() {
      let id = localStorage.getItem("vapush_id");
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem("vapush_id", id);
      }
      return id;
    }

    // Convert base64url to Uint8Array
    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    async function checkSubscription() {
      if (!("serviceWorker" in navigator)) return false;
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.getSubscription();
      return !!sub;
    }

    async function updateUI() {
      const isSubscribed = await checkSubscription();
      subscribeBtn.style.display = isSubscribed ? "none" : "block";
      unsubscribeBtn.style.display = isSubscribed ? "block" : "none";
      if (isSubscribed) {
        status.textContent = "Notifications enabled";
        status.className = "success";
      }
    }

    async function subscribe() {
      try {
        status.textContent = "Registering...";
        status.className = "info";

        // Register service worker
        const reg = await navigator.serviceWorker.register("/sw.js");
        await navigator.serviceWorker.ready;

        // Request permission
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
          status.textContent = "Permission denied";
          status.className = "error";
          return;
        }

        // Get VAPID public key
        const keyRes = await fetch("/api/public-key");
        const { publicKey } = await keyRes.json();

        // Subscribe to push
        const subscription = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey),
        });

        // Send to server
        const res = await fetch("/api/subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: getBrowserId(),
            subscription: subscription.toJSON(),
            secret,
          }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || "Subscribe failed");
        }

        status.textContent = "Notifications enabled!";
        status.className = "success";
        updateUI();
      } catch (err) {
        status.textContent = err.message;
        status.className = "error";
      }
    }

    async function unsubscribe() {
      try {
        const reg = await navigator.serviceWorker.ready;
        const subscription = await reg.pushManager.getSubscription();
        if (subscription) {
          await subscription.unsubscribe();
        }

        await fetch("/api/unsubscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: getBrowserId(),
            secret,
          }),
        });

        status.textContent = "Notifications disabled";
        status.className = "info";
        updateUI();
      } catch (err) {
        status.textContent = err.message;
        status.className = "error";
      }
    }

    subscribeBtn.addEventListener("click", subscribe);
    unsubscribeBtn.addEventListener("click", unsubscribe);

    // Check initial state
    if (secret) {
      updateUI();
    }
  </script>
</body>
</html>
